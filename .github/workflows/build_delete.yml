name: Delete Pages Build Deployment Tasks

on:
  schedule:
    # Run every day at 6 AM IST (12:30 AM UTC)
    - cron: '30 0 * * *'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  delete-pages-builds:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: Delete pages-build-deployment workflow runs
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Get the repository info
          REPO_OWNER=$(echo ${{ github.repository }} | cut -d'/' -f1)
          REPO_NAME=$(echo ${{ github.repository }} | cut -d'/' -f2)
          
          echo "Repository: $REPO_OWNER/$REPO_NAME"
          echo "Searching for pages-build-deployment workflow runs..."
          
          # Get all workflow runs for pages-build-deployment with more details
          echo "Fetching workflow runs..."
          WORKFLOW_RUNS_JSON=$(gh api repos/$REPO_OWNER/$REPO_NAME/actions/runs \
            --jq '.workflow_runs[] | select(.name == "pages-build-deployment") | {id: .id, status: .status, created_at: .created_at}' \
            --paginate)
          
          if [ -z "$WORKFLOW_RUNS_JSON" ]; then
            echo "No pages-build-deployment workflow runs found."
            exit 0
          fi
          
          echo "Found workflow runs:"
          echo "$WORKFLOW_RUNS_JSON"
          
          # Extract just the IDs
          WORKFLOW_RUNS=$(echo "$WORKFLOW_RUNS_JSON" | jq -r '.id')
          
          if [ -z "$WORKFLOW_RUNS" ]; then
            echo "No workflow run IDs found."
            exit 0
          fi
          
          echo "Workflow run IDs to delete:"
          echo "$WORKFLOW_RUNS"
          
          # Delete each workflow run
          DELETED_COUNT=0
          FAILED_COUNT=0
          
          for run_id in $WORKFLOW_RUNS; do
            echo "Attempting to delete workflow run: $run_id"
            
            # Use curl for more detailed error reporting
            HTTP_STATUS=$(curl -s -w "%{http_code}" -o /tmp/response.txt \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: token $GITHUB_TOKEN" \
              -X DELETE \
              "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/actions/runs/$run_id")
            
            if [ "$HTTP_STATUS" -eq 204 ]; then
              echo "‚úì Successfully deleted workflow run: $run_id"
              DELETED_COUNT=$((DELETED_COUNT + 1))
            else
              echo "‚úó Failed to delete workflow run: $run_id (HTTP: $HTTP_STATUS)"
              if [ -f /tmp/response.txt ]; then
                echo "Error response: $(cat /tmp/response.txt)"
              fi
              FAILED_COUNT=$((FAILED_COUNT + 1))
            fi
            
            # Small delay to avoid rate limiting
            sleep 2
          done
          
          echo "Summary: $DELETED_COUNT deleted, $FAILED_COUNT failed"
          
          echo "Cleanup completed!"
      
      - name: Verify workflow runs deletion
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Get the repository info
          REPO_OWNER=$(echo ${{ github.repository }} | cut -d'/' -f1)
          REPO_NAME=$(echo ${{ github.repository }} | cut -d'/' -f2)
          
          echo "Verifying deletion results..."
          
          # Check how many pages-build-deployment runs remain
          REMAINING_RUNS=$(gh api repos/$REPO_OWNER/$REPO_NAME/actions/runs \
            --jq '.workflow_runs[] | select(.name == "pages-build-deployment") | .id' \
            --paginate | wc -l)
          
          echo "Remaining pages-build-deployment workflow runs: $REMAINING_RUNS"
          
          if [ "$REMAINING_RUNS" -eq 0 ]; then
            echo "‚úÖ All pages-build-deployment workflow runs have been successfully deleted!"
          else
            echo "‚ö†Ô∏è  Some workflow runs may still exist. This could be due to:"
            echo "   - Recently created runs that weren't captured in this cleanup"
            echo "   - Permission issues with certain runs"
            echo "   - Rate limiting"
            echo "   - Runs that are currently in progress"
          fi
          
          # Show workflow status for reference
          WORKFLOW_ID=$(gh api repos/$REPO_OWNER/$REPO_NAME/actions/workflows \
            --jq '.workflows[] | select(.name == "pages-build-deployment") | .id' 2>/dev/null || echo "")
          
          if [ -n "$WORKFLOW_ID" ]; then
            echo ""
            echo "üìù Note: The pages-build-deployment workflow (ID: $WORKFLOW_ID) still exists"
            echo "   This is normal - only the run history was deleted, not the workflow itself"
            echo "   The workflow will continue to run automatically when pages are built"
          fi