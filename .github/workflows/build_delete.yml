name: Delete Pages Build Deployment Tasks

on:
  schedule:
    # Run every day at 6 AM IST (12:30 AM UTC)
    - cron: '30 0 * * *'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  delete-pages-builds:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: Delete pages-build-deployment workflow runs
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Get the repository info
          REPO_OWNER=$(echo ${{ github.repository }} | cut -d'/' -f1)
          REPO_NAME=$(echo ${{ github.repository }} | cut -d'/' -f2)
          
          echo "Searching for pages-build-deployment workflow runs..."
          
          # Get all workflow runs for pages-build-deployment
          WORKFLOW_RUNS=$(gh api repos/$REPO_OWNER/$REPO_NAME/actions/runs \
            --jq '.workflow_runs[] | select(.name == "pages-build-deployment") | .id' \
            --paginate)
          
          if [ -z "$WORKFLOW_RUNS" ]; then
            echo "No pages-build-deployment workflow runs found."
            exit 0
          fi
          
          echo "Found workflow runs to delete:"
          echo "$WORKFLOW_RUNS"
          
          # Delete each workflow run
          DELETED_COUNT=0
          FAILED_COUNT=0
          
          for run_id in $WORKFLOW_RUNS; do
            echo "Deleting workflow run: $run_id"
            if gh api repos/$REPO_OWNER/$REPO_NAME/actions/runs/$run_id -X DELETE 2>/dev/null; then
              echo "✓ Successfully deleted workflow run: $run_id"
              DELETED_COUNT=$((DELETED_COUNT + 1))
            else
              echo "✗ Failed to delete workflow run: $run_id"
              FAILED_COUNT=$((FAILED_COUNT + 1))
            fi
            # Small delay to avoid rate limiting
            sleep 1
          done
          
          echo "Summary: $DELETED_COUNT deleted, $FAILED_COUNT failed"
          
          echo "Cleanup completed!"
      
      - name: Check pages-build-deployment workflow status
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Get the repository info
          REPO_OWNER=$(echo ${{ github.repository }} | cut -d'/' -f1)
          REPO_NAME=$(echo ${{ github.repository }} | cut -d'/' -f2)
          
          echo "Checking for pages-build-deployment workflow..."
          
          # Try to find the workflow
          WORKFLOW_ID=$(gh api repos/$REPO_OWNER/$REPO_NAME/actions/workflows \
            --jq '.workflows[] | select(.name == "pages-build-deployment") | .id' 2>/dev/null || echo "")
          
          if [ -n "$WORKFLOW_ID" ]; then
            echo "Found pages-build-deployment workflow with ID: $WORKFLOW_ID"
            echo "Note: This is a system-generated GitHub Pages workflow that cannot be disabled via API"
            echo "It will continue to run automatically when pages are built"
            echo "Only the workflow runs (history) can be deleted, not the workflow itself"
          else
            echo "No pages-build-deployment workflow found."
          fi